# Процессор

![схема процессора (кликните на ссылку с зажатым ctrl или cmd для macOS)](todo)

Процессор состоит из двух локальных регистров (A и D), программного счетчика и АЛУ. Локальный регистр D хранит данные. Локальный регистр А тоже хранит данные, но еще используется для адресации. Аутпут регистра А является `address` инпутом памяти и `data` инпутом программного счетчика. Программный счетчик отвечает за получение инструкций из памяти инструкций и выполнение условных переходов.

Задача процессора выполнять инструкции. Процессор получает (fetch) 16-битную инструкцию из `instruction` инпута и выполняет ее (execute). Процессор работает в fetch-execute цикле, пока компьютер не выключат.

**Этап получения инструкции (fetch).** Аутпут программного счетчика напрямую подключен к `address` инпуту памяти инструкций (ROM). Аутпут ROM — это `instruction` инпут процессора. Счетчик увеличивается: 1, 2, 3, 4, 5 — процессор последовательно получает инструкции из ROM в `instruction` инпут.

**Этап выполнения инструкции (execute).** Инструкция разделяется по битам: ixxaccccccdddjjj. Далее отдельные биты инструкции передаются в различные инпуты чипов. Это хорошо видно на схеме.

Бит i определяет тип выполняемой инструкции: 0 кодирует инструкцию А; 1 кодирует инструкцию C. Рассмотрим инструкцию А и C подробнее.

## Инструкция A (address)

Инструкция А записывает в локальный регистр А 15-битное число.

Пример инструкции А: 0100110101101010. Наиболее значимый бит (msb) всегда равен 0, он кодирует инструкцию А. Остальные 15 бит кодируют число, которое записывается в локальный регистр А. Регистр А 16-битный, поэтому по-факту в регистр записывается вся инструкция (16 бит), но так как msb бит всегда равен 0, мы говорим, что записывается 15-битное число.

Еще примеры инструкции А:

- 0110100100110101: записать в регистр А число 26933.
- 0001101011111100: записать в регистр А число 6908.
- 0110101010101011: записать в регистр А число 27307.

## Инструкция C (compute)

Инструкция С выполняет вычисление в АЛУ с сохранением результата в локальный регистр (A или D) или один из регистров RAM (M). Еще инструкция C выполняет условный или безусловный переход. Обычно делается что-то одно: или вычисление в АЛУ, или переход.

Инструкция С: 1xxaccccccdddjjj. Наиболее значимый бит (msb) всегда равен 1, он кодирует инструкцию С.

Рассмотрим биты по отдельности:

- Биты `xx` не используются. Они всегда равны 11.
- Бит `a` определяет второй инпут АЛУ: регистр A или M. Первый инпут АЛУ — регистр D. Первый инпут АЛУ постоянный, второй инпут АЛУ выбирается через мультиплексор. Бит `a` — `load` бит этого мультиплексора.
- Биты `cccccc` — контрол биты АЛУ. Передаются один к одному в `zx, nx, zy, ny, f, no` биты АЛУ.
- Биты `ddd` определяют в какой регистр будет сохранен аутпут АЛУ: A, D, M или во все сразу. О регистре M будет подробно рассказано далее.
- Биты `jjj` определяют условный или безусловный переход программного счетчика. Об этом далее.

![Таблица битов инструкции C (кликните на ссылку с зажатым ctrl или cmd для macOS)](img/C-instruction.png)

## Регистр А

Регистр А выполняет три задачи: (1) хранит данные, (2) указывает на активный регистр в RAM, (3) определяет переход PC. Аутпут регистра А является `address` инпутом RAM чипа и `data` инпутом PC.

Остановимся на выборе регистра RAM через M регистр.

### Регистр M

Регистр M — это активный регистр RAM. Выбор регистра M происходит через регистр А.

Чтобы выбрать 17-ый регистр в RAM — нужно сохранить 17 в регистр А, а потом обратиться к регистру M. Чтобы выбрать 29-ый регистр RAM — нужно сохранить 29 в регистр A, а потом обратиться к регистру M. Регистр `M = RAM[A]`.

Пример двух инструкций, которые сохраняют значение из RAM[17] в регистр D:

```java
0000000000010001 // Инструкция А: A=17. Записали 17 в регистр А.
1111110000010000 // Инструкция C: D=M, где M==RAM[A]==RAM[17]
```

Мы также можем сохранить значение в M регистр. Выбираем нужный регистр RAM через запись его адреса в регистр А, а затем сохраняем нужное значение в регистр M.

Допустим, мы хотим сохранить в 98-ый регистр RAM значение из регистра D.

```java
0000000001100010 // Инструкция А: A=98
1110001100001000 // Инструкция C: M=D, где M==RAM[A]==RAM[98]
```

## Переход программного счетчика

Биты `jjj` и аутпут-флаги АЛУ определяют переход программного счетчика. Переход может быть условным или безусловным.
